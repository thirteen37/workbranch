#!/bin/bash
# wb-list - List git worktrees with status information
# Output format designed for Claude Code to parse

set -euo pipefail

# Get the git root directory
if ! git_root=$(git rev-parse --show-toplevel 2>/dev/null); then
    echo "ERROR: Not in a git repository | ACTION: Navigate to a git repository first"
    exit 1
fi

# Get default branch (main or master)
default_branch=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "main")

# Parse git worktree list --porcelain
worktree_count=0
current_worktree=""
current_branch=""
current_head=""

echo "WORKTREES:"
echo "=========="

while IFS= read -r line || [[ -n "$line" ]]; do
    if [[ "$line" =~ ^worktree\ (.+)$ ]]; then
        # Output previous worktree if exists
        if [[ -n "$current_worktree" ]]; then
            # Get ahead/behind count
            if [[ -n "$current_branch" && "$current_branch" != "(detached)" ]]; then
                ahead_behind=$(git rev-list --left-right --count "$default_branch...$current_branch" 2>/dev/null | tr '\t' '/' || echo "?/?")
            else
                ahead_behind="-"
            fi
            echo "  $current_worktree"
            echo "    branch: $current_branch"
            echo "    ahead/behind $default_branch: $ahead_behind"
            echo ""
            ((worktree_count++))
        fi
        current_worktree="${BASH_REMATCH[1]}"
        current_branch=""
        current_head=""
    elif [[ "$line" =~ ^branch\ refs/heads/(.+)$ ]]; then
        current_branch="${BASH_REMATCH[1]}"
    elif [[ "$line" =~ ^detached$ ]]; then
        current_branch="(detached)"
    elif [[ "$line" =~ ^HEAD\ (.+)$ ]]; then
        current_head="${BASH_REMATCH[1]}"
    fi
done < <(git worktree list --porcelain)

# Output last worktree
if [[ -n "$current_worktree" ]]; then
    if [[ -n "$current_branch" && "$current_branch" != "(detached)" ]]; then
        ahead_behind=$(git rev-list --left-right --count "$default_branch...$current_branch" 2>/dev/null | tr '\t' '/' || echo "?/?")
    else
        ahead_behind="-"
    fi
    echo "  $current_worktree"
    echo "    branch: $current_branch"
    echo "    ahead/behind $default_branch: $ahead_behind"
    echo ""
    ((worktree_count++))
fi

echo "Total: $worktree_count worktree(s)"
