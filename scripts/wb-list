#!/usr/bin/env zsh
# wb-list - List git worktrees with status information
# Usage: wb-list [-h|--help]
# Output format designed for Claude Code to parse

set -euo pipefail

SCRIPT_DIR="${0:A:h}"
source "$SCRIPT_DIR/wb-lib"

usage() {
    echo "Usage: wb-list"
    echo ""
    echo "Lists all git worktrees with status information."
    echo "Shows branch name and ahead/behind count vs default branch."
    exit 1
}

# Handle help flag
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
    usage
fi

# Get the git root directory
git_root=$(wb_require_git_root)

# Get default branch (main or master)
default_branch=$(wb_get_default_branch)
if [[ -z "$default_branch" ]]; then
    default_branch="main"  # fallback for display purposes
fi

# Parse git worktree list --porcelain
worktree_count=0
current_worktree=""
current_branch=""
current_head=""

echo "WORKTREES:"
echo "=========="

while IFS= read -r line || [[ -n "$line" ]]; do
    if [[ "$line" =~ '^worktree (.+)$' ]]; then
        # Output previous worktree if exists
        if [[ -n "$current_worktree" ]]; then
            # Get ahead/behind count
            if [[ -n "$current_branch" && "$current_branch" != "(detached)" ]]; then
                ahead_behind=$(git rev-list --left-right --count "$default_branch...$current_branch" 2>/dev/null | tr '\t' '/' || echo "?/?")
            else
                ahead_behind="-"
            fi
            echo "  $current_worktree"
            echo "    branch: $current_branch"
            echo "    ahead/behind $default_branch: $ahead_behind"
            echo ""
            ((++worktree_count))
        fi
        current_worktree="$match[1]"
        current_branch=""
        current_head=""
    elif [[ "$line" =~ '^branch refs/heads/(.+)$' ]]; then
        current_branch="$match[1]"
    elif [[ "$line" =~ '^detached$' ]]; then
        current_branch="(detached)"
    elif [[ "$line" =~ '^HEAD (.+)$' ]]; then
        current_head="$match[1]"
    fi
done < <(git worktree list --porcelain)

# Output last worktree
if [[ -n "$current_worktree" ]]; then
    if [[ -n "$current_branch" && "$current_branch" != "(detached)" ]]; then
        ahead_behind=$(git rev-list --left-right --count "$default_branch...$current_branch" 2>/dev/null | tr '\t' '/' || echo "?/?")
    else
        ahead_behind="-"
    fi
    echo "  $current_worktree"
    echo "    branch: $current_branch"
    echo "    ahead/behind $default_branch: $ahead_behind"
    echo ""
    ((worktree_count++))
fi

echo "Total: $worktree_count worktree(s)"
