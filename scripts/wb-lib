# wb-lib - Shared functions for workbranch scripts
# Source this file, don't execute it

# Get git root, exit if not in repo
wb_require_git_root() {
    local git_root
    if ! git_root=$(git rev-parse --show-toplevel 2>/dev/null); then
        echo "ERROR: Not in a git repository | ACTION: Navigate to a git repository first"
        exit 1
    fi
    echo "$git_root"
}

# Get default branch with robust fallback (from wb-done's logic)
wb_get_default_branch() {
    local branch
    branch=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "")
    if [[ -z "$branch" ]]; then
        if git show-ref --verify --quiet refs/heads/main; then
            branch="main"
        elif git show-ref --verify --quiet refs/heads/master; then
            branch="master"
        fi
    fi
    echo "$branch"
}

# Normalize path (make absolute, resolve ..)
# Works even if intermediate directories don't exist
wb_normalize_path() {
    local path="$1"
    local base_dir="${2:-$(pwd)}"

    # Make absolute if relative
    if [[ "$path" != /* ]]; then
        path="$base_dir/$path"
    fi

    # Use realpath -m if available (GNU coreutils), otherwise pure sed
    # Note: macOS realpath doesn't support -m flag
    if realpath -m / &>/dev/null 2>&1; then
        realpath -m "$path"
    else
        # Pure sed fallback (works on all systems)
        echo "$path" | sed 's|/[^/]*/\.\./|/|g; s|/\./|/|g; s|//|/|g'
    fi
}
