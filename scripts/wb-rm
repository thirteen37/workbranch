#!/usr/bin/env zsh
# wb-rm - Remove a git worktree
# Usage: wb-rm <worktree-path> [--delete-branch]

set -euo pipefail

SCRIPT_DIR="${0:A:h}"
source "$SCRIPT_DIR/wb-lib"

usage() {
    echo "Usage: wb-rm <worktree-path> [--delete-branch]"
    echo ""
    echo "Removes the specified git worktree."
    echo ""
    echo "Options:"
    echo "  --delete-branch    Also delete the branch after removing worktree"
    exit 1
}

# Parse arguments
if [[ $# -lt 1 ]]; then
    usage
fi

worktree_path="$1"
delete_branch=false

shift
while [[ $# -gt 0 ]]; do
    case "$1" in
        --delete-branch) delete_branch=true ;;
        -h|--help) usage ;;
        *) echo "ERROR: Unknown option: $1 | ACTION: Use -h or --help to see valid options"; exit 1 ;;
    esac
    shift
done

# Verify we're in a git repository
git_root=$(wb_require_git_root)

# Normalize path (make absolute, resolve ..)
worktree_path=$(wb_normalize_path "$worktree_path" "$(pwd)")

# Check if worktree exists
if ! git worktree list --porcelain | grep -q "^worktree $worktree_path$"; then
    echo "ERROR: No worktree found at $worktree_path | ACTION: Check path with wb-list"
    exit 1
fi

# Get branch name from worktree
branch_name=""
in_target=false
while IFS= read -r line; do
    if [[ "$line" == "worktree $worktree_path" ]]; then
        in_target=true
    elif $in_target; then
        if [[ "$line" =~ '^branch refs/heads/(.+)$' ]]; then
            branch_name="$match[1]"
            break
        elif [[ "$line" =~ '^worktree' ]]; then
            break
        fi
    fi
done < <(git worktree list --porcelain)

# Check if this is the main worktree
main_worktree=$(git worktree list --porcelain | grep "^worktree " | head -1 | sed 's/^worktree //')
if [[ "$worktree_path" == "$main_worktree" ]]; then
    echo "ERROR: Cannot remove main worktree | ACTION: This is the primary repository, not a worktree"
    exit 1
fi

# Remove worktree
echo "Removing worktree at $worktree_path..."

if ! git worktree remove "$worktree_path" 2>&1; then
    echo "ERROR: Worktree has uncommitted changes | ACTION: Commit or stash changes before removing, or use 'rm -rf' to force"
    exit 1
fi

echo "Worktree removed."

# Delete branch if requested
if $delete_branch && [[ -n "$branch_name" ]]; then
    echo "Deleting branch '$branch_name'..."

    # Try safe delete first
    if git branch -d "$branch_name" 2>&1; then
        echo "Branch deleted."
    else
        echo "WARNING: Branch not fully merged"
        echo "ERROR: Cannot delete unmerged branch | ACTION: Use 'git branch -D $branch_name' to force delete"
        exit 1
    fi
fi

echo ""
echo "SUCCESS: Worktree removed"
[[ -n "$branch_name" ]] && echo "BRANCH: $branch_name ($(if $delete_branch; then echo "deleted"; else echo "kept"; fi))"
