#!/usr/bin/env zsh
# wb-new - Create a new git worktree with config file copying
# Usage: wb-new <branch-name> [source-branch]

set -euo pipefail

SCRIPT_DIR="${0:A:h}"
source "$SCRIPT_DIR/wb-lib"

usage() {
    echo "Usage: wb-new <branch-name> [source-branch]"
    echo ""
    echo "Creates a new git worktree for the specified branch."
    echo "If the branch doesn't exist, it will be created from source-branch (default: current branch)."
    echo ""
    echo "Configuration is read from .workbranch in the project root."
    exit 1
}

# Check arguments
if [[ $# -lt 1 ]]; then
    usage
fi

# Handle help flag
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    usage
fi

branch_name="$1"
source_branch="${2:-HEAD}"

# Verify we're in a git repository
git_root=$(wb_require_git_root)

# Load configuration using shared function
wb_parse_config "$git_root/.workbranch"

# Expand path template using ZSH substitution (handles / in branch names)
worktree_path="${WB_CONFIG[path]//\$NAME/$branch_name}"
worktree_path="${worktree_path//\$\{NAME\}/$branch_name}"

# Normalize path (make absolute if relative, resolve ..)
worktree_path=$(wb_normalize_path "$worktree_path" "$git_root")

# Check if worktree already exists
if git worktree list --porcelain | grep -q "^worktree $worktree_path$"; then
    echo "ERROR: Worktree already exists at $worktree_path | ACTION: Use existing worktree or remove it with wb-rm"
    exit 1
fi

# Check if branch exists
branch_exists=false
if git show-ref --verify --quiet "refs/heads/$branch_name" 2>/dev/null; then
    branch_exists=true
fi

# Create worktree
echo "Creating worktree for branch '$branch_name' at $worktree_path..."

if $branch_exists; then
    if ! git worktree add "$worktree_path" "$branch_name" 2>&1; then
        echo "ERROR: Failed to create worktree | ACTION: Check if branch is already checked out elsewhere"
        exit 1
    fi
else
    if ! git worktree add -b "$branch_name" "$worktree_path" "$source_branch" 2>&1; then
        echo "ERROR: Failed to create worktree and branch | ACTION: Check if source branch exists"
        exit 1
    fi
fi

echo "Worktree created successfully."

# Copy config files if patterns specified
if [[ -n "${WB_CONFIG[copy]}" ]]; then
    echo "Copying config files..."

    # Split patterns using ZSH parameter expansion
    local -a patterns
    patterns=("${(@s.:.)WB_CONFIG[copy]}")

    # Split ignore patterns
    local -a ignore_patterns
    ignore_patterns=("${(@s.:.)WB_CONFIG[ignore]}")

    # Process each copy pattern
    for pattern in "${patterns[@]}"; do
        # Use find to get matching files
        while IFS= read -r -d '' file; do
            rel_path="${file#$git_root/}"
            dest_dir="$worktree_path/${rel_path:h}"
            mkdir -p "$dest_dir"
            if ! cp -a "$file" "$dest_dir/" 2>/dev/null; then
                echo "WARNING: Could not copy $file | ACTION: You may need to copy this file manually"
            fi
        done < <(find "$git_root" -path "$git_root/.git" -prune -o -name "$pattern" -print0 2>/dev/null)

        # Also try glob expansion for directory patterns
        for file in "$git_root"/$~pattern(N); do
            if [[ -e "$file" ]]; then
                rel_path="${file#$git_root/}"
                dest_dir="$worktree_path/${rel_path:h}"
                mkdir -p "$dest_dir"
                if ! cp -a "$file" "$dest_dir/" 2>/dev/null; then
                    echo "WARNING: Could not copy $file | ACTION: You may need to copy this file manually"
                fi
            fi
        done
    done

    echo "Config files copied."
fi

# Run post-create commands
if [[ -n "${WB_CONFIG[post_create]}" ]]; then
    echo "Running post-create commands..."
    cd "$worktree_path"

    # Handle multi-line post_create (newline or semicolon separated)
    local -a commands
    commands=("${(@s.;.)WB_CONFIG[post_create]}")
    for cmd in "${commands[@]}"; do
        [[ -z "${cmd// /}" ]] && continue
        echo "  Running: $cmd"
        if ! eval "$cmd"; then
            echo "WARNING: Post-create command failed: $cmd | ACTION: You may need to run this manually"
        fi
    done

    echo "Post-create commands completed."
fi

echo ""
echo "SUCCESS: Worktree ready at $worktree_path"
echo "BRANCH: $branch_name"
